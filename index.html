<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grist Map Widget</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css">
  <style>
    #map {
      width: 100vw;
      height: 100vh;
    }

    html, body, #map {
      margin: 0;
      padding: 0;
    }

    .error {
      background: red;
      color: white;
      padding: 1em;
      text-align: center;
      font-size: 1.2em;
    }

    #settings {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      display: none;
    }

    #settings label {
      display: block;
      margin-bottom: 5px;
    }

    .marker-cluster-selected {
      border: 3px solid #16b378;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script>
    "use strict";

    let map; // Map object
    let markers; // Marker cluster
    let selectedTableId = null;
    let selectedRowId = null;
    const tileLayerURL = "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";
    const tileLayerAttribution = "&copy; <a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors &copy; <a href='https://carto.com/'>CARTO</a>";

    // Default marker icons
    const defaultIcon = L.icon({
      iconUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png",
      shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const selectedIcon = L.icon({
      iconUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-green.png",
      shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    function initializeMap() {
      // Initialize the map with CartoDB.Positron tiles
      map = L.map("map").setView([0, 0], 2); // Default world view
      L.tileLayer(tileLayerURL, {
        attribution: tileLayerAttribution,
        maxZoom: 19,
      }).addTo(map);

      markers = L.markerClusterGroup();
      map.addLayer(markers);
    }

    function updateMap(data) {
      // Clear existing markers
      markers.clearLayers();

      if (!data || data.length === 0) {
        displayError("No map data available.");
        return;
      }

      let bounds = L.latLngBounds();

      data.forEach((record) => {
        const { id, name, lat, lng } = record;

        // Ignore invalid coordinates
        if (!lat || !lng || Math.abs(lat) < 0.01 && Math.abs(lng) < 0.01) {
          return;
        }

        const marker = L.marker([lat, lng], {
          title: name,
          icon: id === selectedRowId ? selectedIcon : defaultIcon,
        }).bindPopup(`<b>${name}</b>`);

        markers.addLayer(marker);
        bounds.extend([lat, lng]);
      });

      if (markers.getLayers().length > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
      } else {
        displayError("No valid points to display.");
      }
    }

    function displayError(message) {
      document.getElementById("map").innerHTML = `<div class="error">${message}</div>`;
    }

    // Listen for Grist messages
    grist.onRecords((records) => {
      const mappedData = records.map((rec) => ({
        id: rec.id,
        name: rec.Name || "Unnamed",
        lat: rec.Latitude || null,
        lng: rec.Longitude || null,
      }));
      updateMap(mappedData);
    });

    grist.onRecord((record) => {
      selectedRowId = record.id;
      updateMap([
        {
          id: record.id,
          name: record.Name || "Unnamed",
          lat: record.Latitude || null,
          lng: record.Longitude || null,
        },
      ]);
    });

    document.addEventListener("DOMContentLoaded", () => {
      initializeMap();
    });
  </script>
</body>
</html>
